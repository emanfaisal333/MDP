<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MDP Visualization - Assignment 2</title>
    <style>
        :root { --cell-size: 100px; --goal: #2ecc71; --trap: #e74c3c; --blue: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; background: #f4f7f6; padding-top: 20px; }
        .dashboard { display: flex; gap: 40px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .controls { display: flex; flex-direction: column; gap: 20px; min-width: 250px; }
        .grid-container { display: grid; grid-template-columns: repeat(4, var(--cell-size)); gap: 8px; background: #bdc3c7; padding: 8px; border-radius: 8px; }
        .cell { width: var(--cell-size); height: var(--cell-size); background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 4px; position: relative; }
        .value-label { font-size: 12px; font-weight: bold; color: #7f8c8d; }
        .arrow { font-size: 28px; color: #2c3e50; font-weight: bold; }
        .goal { background: var(--goal) !important; color: white; }
        .trap { background: var(--trap) !important; color: white; }
        .goal .arrow, .trap .arrow, .goal .value-label, .trap .value-label { color: white; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 5px; background: var(--blue); color: white; font-weight: bold; transition: opacity 0.2s; }
        .reset-btn { background: #95a5a6; }
        #convergence-note { color: #27ae60; font-weight: bold; display: none; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>MDP: Value & Policy Iteration</h1>
    <div class="dashboard">
        <div class="controls">
            <label><strong>Algorithm</strong></label>
            <select id="algorithm" onchange="resetMDP()">
                <option value="value">Value Iteration</option>
                <option value="policy">Policy Iteration</option>
            </select>
            <label><strong>Discount Factor (γ):</strong> <span id="gamma-val">0.9</span></label>
            <input type="range" id="gamma" min="0" max="1" step="0.05" value="0.9" oninput="document.getElementById('gamma-val').innerText = this.value">
            <button class="step-btn" onclick="runStep()">Step Iteration</button>
            <button class="reset-btn" onclick="resetMDP()">Reset Environment</button>
            <div id="stats">
                <div>Iterations: <span id="iter-count">0</span></div>
                <div>Delta (Δ): <span id="delta-val">0.0000</span></div>
                <div id="convergence-note">Optimal Policy Reached!</div>
            </div>
        </div>
        <div id="grid-world" class="grid-container"></div>
    </div>

    <script>
        let iteration = 0;

        // Fetch initial state (0.0 values and default UP arrows) [cite: 25]
        window.onload = async () => {
            const res = await fetch('/get_state');
            updateUI(await res.json());
        };

        async function runStep() {
            const res = await fetch('/step', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    gamma: document.getElementById('gamma').value, 
                    algorithm: document.getElementById('algorithm').value 
                })
            });
            const data = await res.json();
            iteration++;
            updateUI(data);

            // Convergence check [cite: 25, 36]
            if (data.delta < 0.0001) {
                document.getElementById('convergence-note').style.display = 'block';
                const btn = document.querySelector('.step-btn');
                btn.disabled = true; 
                btn.style.opacity = '0.5';
            }
        }

        function updateUI(data) {
            const grid = document.getElementById('grid-world'); 
            grid.innerHTML = '';
            document.getElementById('delta-val').innerText = data.delta.toFixed(6);
            document.getElementById('iter-count').innerText = iteration;
            
            const arrows = { 'UP': '↑', 'DOWN': '↓', 'LEFT': '←', 'RIGHT': '→', 'TERM': '★' };

            data.values.forEach((row, r) => {
                row.forEach((val, c) => {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if (r === 0 && c === 3) cell.classList.add('goal');
                    if (r === 1 && c === 3) cell.classList.add('trap');
                    
                    // Heatmap color logic [cite: 23]
                    if (!cell.classList.contains('goal') && !cell.classList.contains('trap')) {
                        const intensity = Math.min(255, Math.max(180, 255 - (val * 15)));
                        cell.style.backgroundColor = `rgb(${intensity}, ${intensity + 10}, 255)`;
                    }

                    const dir = data.policy[r][c];
                    cell.innerHTML = `
                        <div class="value-label">${val.toFixed(2)}</div>
                        <div class="arrow">${arrows[dir] || ''}</div>
                    `;
                    grid.appendChild(cell);
                });
            });
        }

        async function resetMDP() {
            await fetch('/reset', { method: 'POST' });
            iteration = 0;
            const btn = document.querySelector('.step-btn');
            btn.disabled = false; 
            btn.style.opacity = '1';
            document.getElementById('convergence-note').style.display = 'none';
            const res = await fetch('/get_state'); 
            updateUI(await res.json());
        }
    </script>
</body>
</html>
